{"version":3,"file":"renderer.js","sourceRoot":"","sources":["../src/renderer.ts"],"names":[],"mappings":";;;AAAA,uCAA0F;AAMnF,KAAK,UAAU,cAAc,CAChC,YAAyC,EACzC,eAA4C,EAC5C,EAAE,GAAG,EAAE,OAAO,EAAE,UAAU,EAIzB;IAED,MAAM,WAAW,GAAG,oBAAiB,CAAC,GAAG,EAAE;QACvC,UAAU,EAAE,KAAK;QACjB,gBAAgB,EAAE,IAAI;KACzB,CAAC,CAAC;IAEH,UAAU,CAAC,OAAO,CAAC,cAAc,CAAC,EAAE;QAChC,WAAW,CAAC,YAAY,CAAC,cAAc,CAAC,IAAI,EAAE,IAAI,cAAc,EAAE,CAAC,CAAC;IACxE,CAAC,CAAC,CAAC;IAEH,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,UAAU,EAAE,UAAU,CAAC,EAAE,EAAE;QACzD,WAAW,CAAC,SAAS,CACjB,UAAU,EACV,CAAC,GAAG,IAAI,EAAE,EAAE;YACR,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YAC5B,CAAC,KAAK,IAAI,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,GAAG,IAAI,CAAC,CAAC,EAAE;iBAC5C,IAAI,CACD,KAAK,CAAC,EAAE,CAAC,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAC,EAC9B,KAAK,EAAC,KAAK,EAAC,EAAE;gBACV,IAAI,KAAK,YAAY,KAAK,EAAE;oBACxB,KAAK,CAAC,OAAO,GAAG,GAAG,UAAU,eAAe,KAAK,CAAC,OAAO,EAAE,CAAC;iBAC/D;gBACD,MAAM,KAAK,CAAC;YAChB,CAAC,CACJ;iBACA,KAAK,CAAC,QAAQ,CAAC,CAAC;QACzB,CAAC,EACD,IAAI,CACP,CAAC;IACN,CAAC,CAAC,CAAC;IAGH,MAAM,YAAY,GAAG,MAAM,IAAI,OAAO,CAClC,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;QAChB,WAAW,CAAC,YAAY,CACpB,YAAY,EACZ,eAAe,EACf,CAAC,KAAK,EAAE,MAAM,EAAE,EAAE;YACd,IAAI,KAAK,EAAE;gBACP,MAAM,CAAC,KAAK,CAAC,CAAC;aACjB;iBAAM;gBACH,OAAO,CAAC,MAAM,CAAC,CAAC;aACnB;QACL,CAAC,CACJ,CAAC;IACN,CAAC,CACJ,CAAC;IACF,IAAI,OAAO,YAAY,KAAK,QAAQ,EAAE;QAClC,MAAM,IAAI,KAAK,CACX,gGAAgG,CACnG,CAAC;KACL;IAED,OAAO,YAAY,CAAC;AACxB,CAAC;AA9DD,wCA8DC","sourcesContent":["import { configure as nunjucksConfigure, Extension as NunjucksExtension } from 'nunjucks';\n\ntype NunjucksRenderStringArgs = Parameters<ReturnType<typeof nunjucksConfigure>['renderString']>;\ntype NunjucksFilterFn = (...args: [unknown, ...unknown[]]) => unknown;\ntype NunjucksExtensionConstructor = new () => NunjucksExtension;\n\nexport async function renderNunjucks(\n    templateCode: NunjucksRenderStringArgs[0],\n    templateContext: NunjucksRenderStringArgs[1],\n    { cwd, filters, extensions }: {\n        cwd: string;\n        filters: Record<string, NunjucksFilterFn>;\n        extensions: readonly NunjucksExtensionConstructor[];\n    },\n): Promise<string> {\n    const nunjucksEnv = nunjucksConfigure(cwd, {\n        autoescape: false,\n        throwOnUndefined: true,\n    });\n\n    extensions.forEach(ExtensionClass => {\n        nunjucksEnv.addExtension(ExtensionClass.name, new ExtensionClass());\n    });\n\n    Object.entries(filters).forEach(([filterName, filterFunc]) => {\n        nunjucksEnv.addFilter(\n            filterName,\n            (...args) => {\n                const callback = args.pop();\n                (async () => filterFunc(args.shift(), ...args))()\n                    .then(\n                        value => callback(null, value),\n                        async error => {\n                            if (error instanceof Error) {\n                                error.message = `${filterName}() filter / ${error.message}`;\n                            }\n                            throw error;\n                        },\n                    )\n                    .catch(callback);\n            },\n            true,\n        );\n    });\n\n    type renderStringReturnType = Parameters<Exclude<NunjucksRenderStringArgs[2], undefined>>[1];\n    const generateText = await new Promise<renderStringReturnType>(\n        (resolve, reject) => {\n            nunjucksEnv.renderString(\n                templateCode,\n                templateContext,\n                (error, result) => {\n                    if (error) {\n                        reject(error);\n                    } else {\n                        resolve(result);\n                    }\n                },\n            );\n        },\n    );\n    if (typeof generateText !== 'string') {\n        throw new Error(\n            'Nunjucks render failed: nunjucks.Environment#renderString() method returned a non-string value',\n        );\n    }\n\n    return generateText;\n}\n"]}