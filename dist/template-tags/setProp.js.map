{"version":3,"file":"setProp.js","sourceRoot":"","sources":["../../src/template-tags/setProp.ts"],"names":[],"mappings":"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","sourcesContent":["import * as nunjucks from 'nunjucks';\nimport * as NunjucksLib from 'nunjucks/src/lib';\nimport * as util from 'util';\n\nimport type { Extension as NunjucksExtension } from '../types/nunjucks-extension';\nimport type * as NunjucksNodes from '../types/nunjucks-extension/nunjucks/src/nodes';\nimport {\n    Array2ReadonlyArray,\n    isObject,\n    isValidIdentifierName as isValidPropName,\n} from '../utils';\n\ntype ObjectPathList = Array2ReadonlyArray<\n    ReturnType<ReturnType<SetPropExtension['genGetObjectPath']>>\n>;\n\ninterface ArgType {\n    targetVariableList: ObjectPathList[];\n    value: unknown;\n}\n\nexport default class SetPropExtension implements NunjucksExtension {\n    public tags = ['setProp'];\n\n    #failMsgPrefix = `SetPropExtension#parse: `;\n\n    public parse(\n        parser: NunjucksExtension.Parser,\n        nodes: NunjucksExtension.Nodes,\n        lexer: NunjucksExtension.Lexer,\n    ): NunjucksExtension.ParseResult {\n        const getObjectPath = this.genGetObjectPath(nodes);\n        const value2node = this.genValue2node(nodes);\n\n        const tagNameSymbolToken = parser.nextToken();\n        if (!tagNameSymbolToken)\n            parser.fail(\n                `${this.#failMsgPrefix}expected ${this.tags.join(\n                    ' or ',\n                )}, got end of file`,\n            );\n        const tagName = tagNameSymbolToken.value;\n\n        /**\n         * @see https://github.com/mozilla/nunjucks/blob/v3.2.1/nunjucks/src/parser.js#L496-L503\n         */\n        const targetVarList: ObjectPathList[] = [];\n        for (let target; (target = parser.parsePrimary()); ) {\n            if (\n                !(\n                    target instanceof nodes.LookupVal ||\n                    target instanceof nodes.Symbol\n                )\n            )\n                parser.fail(\n                    `${\n                        this.#failMsgPrefix\n                    }expected variable name or variable reference in ${tagName} tag`,\n                    target.lineno,\n                    target.colno,\n                );\n\n            targetVarList.push(getObjectPath(target));\n\n            if (!parser.skip(lexer.TOKEN_COMMA)) break;\n        }\n\n        if (targetVarList.length < 1)\n            parser.fail(\n                `${\n                    this.#failMsgPrefix\n                }expected one or more variable in ${tagName} tag, got no variable`,\n                parser.tokens.lineno,\n                parser.tokens.colno,\n            );\n\n        /**\n         * @see https://github.com/mozilla/nunjucks/blob/v3.2.1/nunjucks/src/parser.js#L505-L522\n         */\n        let valueNode;\n        let bodyNodeList;\n        if (parser.skipValue(lexer.TOKEN_OPERATOR, '=')) {\n            valueNode = parser.parseExpression();\n            if (!valueNode)\n                parser.fail(\n                    `${\n                        this.#failMsgPrefix\n                    }expected expression in ${tagName} tag`,\n                    parser.tokens.lineno,\n                    parser.tokens.colno,\n                );\n            parser.advanceAfterBlockEnd(tagName);\n        } else {\n            const nextToken = parser.peekToken();\n\n            /**\n             * @see https://github.com/mozilla/nunjucks/blob/v3.2.1/nunjucks/src/parser.js#L122-L130\n             */\n            if (nextToken && nextToken.type === lexer.TOKEN_BLOCK_END) {\n                parser.advanceAfterBlockEnd(tagName);\n            } else {\n                /**\n                 * @see https://github.com/mozilla/nunjucks/blob/v3.2.1/nunjucks/src/parser.js#L1024-L1055\n                 */\n                const errData =\n                    nextToken && nextToken.type === lexer.TOKEN_SYMBOL\n                        ? {\n                              expected: '`,` or =',\n                              lineno: nextToken.lineno,\n                              colno: nextToken.colno,\n                          }\n                        : {\n                              expected: '= or block end',\n                              lineno: parser.tokens.lineno,\n                              colno: parser.tokens.colno,\n                          };\n                parser.fail(\n                    // prettier-ignore\n                    `${this.#failMsgPrefix}expected ${errData.expected} in ${tagName} tag`,\n                    errData.lineno,\n                    errData.colno,\n                );\n            }\n\n            bodyNodeList = parser.parseUntilBlocks('endsetProp', 'endset');\n            parser.advanceAfterBlockEnd();\n        }\n\n        const arg: ArgType = {\n            targetVariableList: targetVarList,\n            value: valueNode,\n        };\n        return new nodes.CallExtension(\n            this,\n            'run',\n            new nodes.NodeList(\n                targetVarList[0][0].lineno,\n                targetVarList[0][0].colno,\n                [\n                    value2node(\n                        arg,\n                        targetVarList[0][0].lineno,\n                        targetVarList[0][0].colno,\n                    ),\n                ],\n            ),\n            bodyNodeList ? [bodyNodeList] : [],\n        );\n    }\n\n    public run(\n        context: {\n            env: unknown;\n            ctx: Record<string, unknown>;\n            blocks: unknown;\n            exported: unknown;\n        },\n        arg: ArgType,\n        body?: () => unknown,\n    ): nunjucks.runtime.SafeString {\n        const value = body ? body() : arg.value;\n\n        for (const objectPathList of arg.targetVariableList) {\n            let obj: Record<string, unknown> = context.ctx;\n            objectPathList.forEach((objectPathItem, index) => {\n                const propName: any = objectPathItem.prop; // eslint-disable-line @typescript-eslint/no-explicit-any\n                const nextIndex = index + 1;\n                const nextObjectPathItem = objectPathList[nextIndex];\n\n                if (!nextObjectPathItem) {\n                    obj[propName] = value;\n                } else {\n                    const o = obj[propName];\n                    if (!isObject(o)) {\n                        const objectPropNameList = objectPathList.map(\n                            ({ prop }) => prop,\n                        );\n                        const { lineno, colno } = nextObjectPathItem;\n                        throw new NunjucksLib.TemplateError(\n                            new TypeError(\n                                'setProp tag / Cannot be assigned to `' +\n                                    this.toPropString(objectPropNameList) +\n                                    '`! `' +\n                                    this.toPropString(\n                                        objectPropNameList.slice(0, nextIndex),\n                                    ) +\n                                    '` variable value is ' +\n                                    (o === null ? 'null' : typeof o) +\n                                    ', not an object',\n                            ),\n                            lineno,\n                            colno,\n                        );\n                    }\n                    obj = o;\n                }\n            });\n        }\n\n        return new nunjucks.runtime.SafeString('');\n    }\n\n    private toPropString(objectPath: unknown[]): string {\n        return objectPath\n            .map((propName, index) =>\n                typeof propName === 'string' && isValidPropName(propName)\n                    ? index === 0\n                        ? propName\n                        : `.${propName}`\n                    : `[${util.inspect(propName)}]`,\n            )\n            .join('');\n    }\n\n    // eslint-disable-next-line @typescript-eslint/explicit-function-return-type\n    private genGetObjectPath(nodes: NunjucksExtension.Nodes) {\n        interface ObjectPathItem {\n            prop: unknown;\n            lineno: number;\n            colno: number;\n        }\n\n        const getObjectPath = (\n            lookupValNode: NunjucksNodes.Symbol | NunjucksNodes.LookupVal,\n        ): ObjectPathItem[] =>\n            lookupValNode instanceof nodes.LookupVal\n                ? [\n                      ...(lookupValNode.target instanceof nodes.Symbol ||\n                      lookupValNode.target instanceof nodes.LookupVal\n                          ? getObjectPath(lookupValNode.target)\n                          : []),\n                      {\n                          prop: lookupValNode.val,\n                          lineno: lookupValNode.lineno + 1,\n                          colno: lookupValNode.colno + 1,\n                      },\n                  ]\n                : [\n                      {\n                          prop: lookupValNode.value,\n                          lineno: lookupValNode.lineno + 1,\n                          colno: lookupValNode.colno + 1,\n                      },\n                  ];\n        return getObjectPath;\n    }\n\n    // eslint-disable-next-line @typescript-eslint/explicit-function-return-type\n    private genValue2node(nodes: NunjucksExtension.Nodes) {\n        const value2node = (\n            value: unknown,\n            lineno: number,\n            colno: number,\n        ): NunjucksNodes.AllNodeType => {\n            if (value instanceof nodes.Node) {\n                return value;\n            } else if (Array.isArray(value)) {\n                return new nodes.Array(\n                    lineno,\n                    colno,\n                    value.map((v) =>\n                        value2node(v, lineno, colno),\n                    ) as NunjucksNodes.Array['children'],\n                );\n            } else if (isObject(value)) {\n                return new nodes.Dict(\n                    lineno,\n                    colno,\n                    Object.entries(value).map(\n                        ([prop, value]) =>\n                            new nodes.Pair(\n                                lineno,\n                                colno,\n                                value2node(\n                                    prop,\n                                    lineno,\n                                    colno,\n                                ) as NunjucksNodes.Literal,\n                                value2node(value, lineno, colno) as ReturnType<\n                                    NunjucksExtension.Parser['parseExpression']\n                                >,\n                            ),\n                    ),\n                );\n            } else {\n                return new nodes.Literal(lineno, colno, value);\n            }\n        };\n\n        return value2node;\n    }\n}\n"]}